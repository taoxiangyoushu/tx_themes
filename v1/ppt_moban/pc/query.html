<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>芝士PPT - 查询结果</title>
    <link rel="shortcut icon" href="../pc/assets/icon.ico" type="image/vnd.microsoft.icon" />
    <!-- Bootstrap -->
    <link rel="stylesheet" href="../pc/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../pc/assets/css/common.css?v=2.0">
    <link rel="stylesheet" href="../pc/assets/css/query/query.css?v=3.0">
    <!-- <link rel="stylesheet" href="../pc/assets/css/styles.css" /> -->
    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!--[if lt IE 9]>
    <script src="https://fastly.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
    <script>
		var JANE_NAME = 'ppt_moban'
		var USER_TOKEN = 'RmlETkdPdjYzZmVjNTVhMDAyYzY='
    </script>
</head>

<body>
<div class="haderNav navbarBox">
    <div class="container">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                        data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                        <span class="sr-only">切换导航</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="./index.html">
                        <img src="../pc/assets/img/logo.png" alt="芝士PPT">
                        <span>PPT模板</span>
                    </a>
                    <span class="logoTips">
                        专业模板，让你脱颖而出
                    </span>
                </div>

                <div class="collapse navbar-collapse topNav" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li><a href="./index.html">首页</a></li>
                        <li class="active"><a href="#">我的订单页</a></li>
                        <a class="trial" href="https://pan.baidu.com/s/1_o-qrHmsnFsxfb3KKSfGPA?pwd=mqwt" target="_blank" rel="noopener noreferrer">下载试用款</a>
                    </ul>
                </div>
            </div>
        </nav>
    </div>
</div>

<div class="container mainDiv">
    <div class="leftDiv">
        <div class="security">
            <h3>六大权益保障</h3>
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <img src="../pc/assets/img/page.png" alt="">
                        <div class="text">
                            <b>页页精品</b>
                            <p>页页不重样，页页精品</p>
                        </div>
                    </div> 
                </div>
                <div class="col-md-12">
                    <div class="card">
                        <img src="../pc/assets/img/caseShow.png" alt="">
                        <div class="text">
                            <b>丰富案例</b>
                            <p>丰富行业案例，附带使用说明</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="card">
                        <img src="../pc/assets/img/freemodification.png" alt="">
                        <div class="text">
                            <b>自由修改</b>
                            <p>元素/数据等都可编辑替换</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="card">
                        <img src="../pc/assets/img/teacher.png" alt="">
                        <div class="text">
                            <b>专属导师</b>
                            <p>专属导师，提供模板使用答疑</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="card">
                        <img src="../pc/assets/img/perpetuity.png" alt="">
                        <div class="text">
                            <b>永久使用</b>
                            <p>一次付费，模板可永久使用</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="card">
                        <img src="../pc/assets/img/exclusiveOriginal.png" alt="">
                        <div class="text">
                            <b>独家原创</b>
                            <p>原创模板，版权归芝士PPT所有，<br>不可盗卖</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="purchaseTips">
            <h3>购买须知</h3>
            <div class="contentTips">
                <div class="QueenText"><img src="../pc/assets/img/tips.png" alt=""> 温馨提示</div>
                <div class="textTips">
                    亲，高端汇报PPT模板的商品为<span>电子文件，非实物，不支持退换货</span>，谨慎下单。下单即发货，不退不换。高峰期订单较多，发货时间会有所延长。
                </div>

                <div class="QueenText"><img src="../pc/assets/img/security.png" alt=""> 安全保障</div>
                <div class="textTips">
                    <span>安全保障</span>：系统保留30天以内的订单，超过30天则被删除，购买成功后请尽快复制链接下载! 
                </div>
                <div class="importantText">
                    请慎重记录并保管好您的订单号以便日后查询，离开此页则不再显示。
                </div>
            </div>
        </div>
    </div>
    <div class="rightDiv">
        <div class="ContentMain">
            <div class="orderTips">
                购买订单仅保留30天，请尽快复制链接下载到电脑永久保存
            </div>
            <!-- <i class="line"></i> -->
            <div class="report-block">
                <div class="searchParameters">
                    <span class="orderId-name">订单编号：</span>
                    <div class="orderIdBox">
                        <input autocomplete="off" id="orderId" class="orderId form-control" maxlength="30" type="text" placeholder="输入订单号/优惠券查询结果" />
                        <span class="deleteS"></span>
                    </div>
                    <div class="searchBtn">搜索</div>
                    <div class="pointOut">
                        <div class="wxorder pull-left">
                            <img src="../pc/assets/img/order-alipayId.png" alt="支付宝图标">
                            <span>支付宝订单号？</span>
                            <div class="orderImg">
                                <img src="../pc/assets/img/alinAd.png" alt="支付宝订单" class="orderIMG-s">
                            </div>
                        </div>
                        <div class="aliorder pull-left">
                            <img src="../pc/assets/img/order-wx.png" alt="微信图标">
                            <span>微信订单号?</span>
                            <div class="orderImg zhifubaoOrder">
                                <img src="../pc/assets/img/alinAd2.jpg" alt="微信订单" class="orderIMG-s">
                            </div>
                        </div>
                        <div class="taobaoOrder pull-left">
                            <img src="../pc/assets/img/taobao.png" alt="淘宝图标">
                            <span>淘宝订单号?</span>
                            <div class="orderImg taobao-Order">
                                <img src="../pc/assets/img/taobao_oid.png" alt="淘宝订单" class="orderIMG-s">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="report-box">
                    <table class="orderInformation table" border="1" cellspacing="0">
                        <thead>
                            <tr>
                                <th width="180">订单编号</th>
                                <th>商品名称</th>
                                <th>下单时间</th>
                                <th width="120">状态</th>
                                <th width="180" class="operation-tr">操作</th>
                            </tr>
                        </thead>
                        <tbody class="tbody report-area"></tbody>
                    </table>
                    <input id="copyInput" type="text">
                    <div class="nodata-block">
                        <img src="../pc/assets/img/nodata.png" alt="">
                        <p class="nodata-text">请输入订单编号查询</p>
                        <!-- <div class="toSubmit">
                            <a href="./index.html">去下单</a>
                        </div> -->
                    </div>
                    <div class="loadLine loading">
                        <img src="../pc/assets/img/loading2.gif" alt="">
                        <p>加载中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="CustomerService">
    <img class="img-ico" src="../pc/assets/img/kf_nor_ico.png" alt="">
    <img class="img-ico-active" src="../pc/assets/img/kf_pre_ico.png" alt="">
    <div class="customerBox">
        <div class="head">
            <img src="../pc/assets/img/kf.png" alt="">
            <span class="customer-title">联系客服</span>
        </div>
        <div class="customerCode">
            <img class="customer-qr" src="" alt="">
        </div>
        <div class="segmentation-line"></div>
        <div class="customerWay">
            <p class="wxText"><span class="s0">微信:</span> <span class="s1"></span></p>
            <p class="qqText"><span class="s0">Q Q:</span> <span class="s1"></span></p>
            <p class="telephone"><span class="s0">电话:</span> <span class="s1"></span></p>
            <p class="mailbox"><span class="s0">邮箱:</span> <span class="s1"></span></p>
        </div>
        <p class="noCustomer">商家未设置客服</p>
        <img class="customBg" src="../pc/assets/img/bg1.png" alt="">
    </div>
</div>
<div class="mask_body"></div>
<div class="delete-pop">
    <div class="pop_top">
        <div class="pop_title">删除提醒</div>
        <img class="close_pop" src="../pc/assets/img/delete_report.png" alt="">
    </div>
    <div class="pop_cont">
        <p class="p1">是否确定删除订单？删除后，无法恢复</p>
        <div class="back_block">
            <p class="p2">系统仅保留30天内的订单，</p>
            <p class="p3">确保您的订单不会被覆盖和盗窃</p>
        </div>
    </div>
    <div class="pop_bottom">
        <div class="cancel_btn">取消</div>
        <div class="determine_btn">确定</div>
    </div>
</div>

<div class="Bottom">

</div>
</body>
<script src="https://cdn.taoxiangyoushu.com/html/v1/utils/js/IeOutTips.js?code=11.0"></script>
<script src="../pc/assets/js/jquery.min.js"></script>
<script src="https://cdn.taoxiangyoushu.com/tools/safari_handle.js?code=11.6"></script>
<script src="../pc/assets/js/bootstrap.min.js"></script>
<script src="../pc/assets/js/bootstrapValidator.min.js"></script>
<script src="../pc/assets/js/coco-message.js"></script>
<!-- <script src="https://api.taoxiangyoushu.com/html/v1/utils/js/complainTS.js?v=1.9"></script> -->
<script src="../pc/assets/js/common.js?v=1.1"></script>
<script>
    function startQuerying(){
        if(getQueryVariable('oid')) {
            $('.orderId').val(getQueryVariable('oid'))
            query(false)
        }else if(localStorage.getItem('oid')) {
            $('.orderId').val(localStorage.getItem('oid'))
            query(false)
        }
    }
    $('#orderId').on('input',function (){
        if(!$('#orderId').val()){
            $(".deleteS").hide()
        }else{
            $(".deleteS").show()
        }
    })

    var isTrue;
    $('.searchBtn').click(function() {
        if(isTrue) return
        isTrue = true
        setTimeout(() => {
            isTrue = false
        },3000)
        if(!$('#orderId').val()) {
            cocoMessage.destroyAll();
            cocoMessage.error("请输入订单号或优惠券后查询!", 2000);
            $(".guide").html("输入订单号/优惠券查询结果")
            $('.report-area').hide()
            $('.nodata-block').show()
        }else {
            query(true)
        }
    })

    function query(e) {
        cocoMessage.destroyAll();
        if(e) cocoMessage.success('正在为您查询...')
        $('.loadLine').show()
        $('.nodata-block').hide()
        $('.report-area').children().remove()
        $.ajax({
            type: "post",
            url: urls + "/api/client/order/order_list/order_id?user_token="+USER_TOKEN+"&jane_name="+JANE_NAME,
            processData: false,
            contentType: false,
            xhrFields: {
                withCredentials: true
            },
            data: getFormData({
                pay_id: $('#orderId').val(),
                user_token: USER_TOKEN,
                jane_name: JANE_NAME,
            }),
            success: function (res) {
                $('.nodata-block').hide()
                $('.report-area').children().remove()
                var text = "";
                var automaticPolling = false;
                $('.operation-tr').attr('width', '180px')
                if(res.data.length && res.data[0].jane_name==JANE_NAME) {
                    for(var i=0; i<res.data.length; i++) {
                        var payId = res.data[i].order_sn
                        var resData = res.data[i]
                        var rate_ExplicitImplicit = ''
                        var statusClass = ''
                        if(resData.end_product){
                            rate_ExplicitImplicit = 'rateExplicit'
                            statusClass = 'status-2'
                        }else{
                            rate_ExplicitImplicit = 'rateImplicit'
                            statusClass = 'status-1'
                        }
                        text += '  <tr>' +
                            '          <th class="first">'+ resData.order_sn +'</th>' +
                            '          <th class="titles" title="'+ resData.goods_name +'">'+ resData.goods_name +'</th>' +
                            '          <th class="">'+ resData.created +'</th>' +
                            '          <th>'+
                            '              <div class="report-status '+ statusClass +'">' +
                                               resData.order_status_human +
                            '              </div>'+
                            '          </th>' +
                            '          <th>'
                            if(!resData.isBind && threeMsg.wx && !resData.end_product){
                                text += '<div class="scanFollow">' +
                                    '    <div class="codeBox">' +
                                    '        <img class="codeImg'+ i +'" src="../pc/assets/img/loading2.gif" alt="">' +
                                    '    </div>' +
                                    '    <div class="tipsText">' +
                                    '        <p class="p-1">扫码关注</p>' +
                                    '        <p class="p-1 noMarginTop">实时了解订单进度</p>' +
                                    '        <p class="p-2">如果您未绑定</p>' +
                                    '        <p class="p-2 noMarginTop">请一定保存订单号</p>' +
                                    '    </div>' +
                                    '</div>'
                            }else{
                                text += '<div class="report-operate '+ rate_ExplicitImplicit +'">' +
                                    '        <a class="download CopyCode" data-code="'+ resData.end_product +'" href="javascript:">复制链接</a>'+
                                    '        <div class="delete delete_btn" data-orderid="'+ resData.order_sn  +'">' +
                                    '             删除' +
                                    '        </div>' +
                                    '    </div>'
                            }

                        text+= '          </th>' +
                            '      </tr>'
                        if(resData.order_status != 60) {
                            automaticPolling = true
                            if(threeMsg.wx && !resData.isBind){
                                $('.operation-tr').attr('width', '240px')
                                getWxCode(resData.order_sn, 'codeImg'+i)
                            }
                        }else{
                            if(WxTimeOut){
                                WxTime = 0
                                clearTimeout(WxTimeOut)
                            }
                        }
                    }
                    if(automaticPolling){
                        setTimer()
                    }
                    $('.report-area').append(text)
                    $('.report-area').show()
                    localStorage.setItem('oid',$('#orderId').val());
                    $('.deleteS').show()
                }else {
                    deleteS(true)
                   $('.report-area').hide()
                    $('.nodata-block').show()
                    cocoMessage.destroyAll();
                    if(res.code == 400) {
                        cocoMessage.error(res.codeMsg, 2000);
                        $(".guide").html(res.codeMsg)
                    }else {
                        cocoMessage.error("未查询到结果!", 2000);
                        $(".guide").html("非常抱歉，没有找到该订单号。<\/br>请重新核对是否输入了正确的订单号或者记录已被删除")
                    }
                }
                $('.loadLine').hide()
            },
            error: function () {
               $('.report-area').hide()
                $('.nodata-block').show()
                cocoMessage.destroyAll();
                cocoMessage.error("请求失败!请检查网络", 2000);
                $('.deleteS').hide()
                $('.loadLine').hide()
            },
        });
    }
    var timers = null
    function setTimer() {
        clearTimeout(timers);
        $.ajax({
            type: "post",
            url: urls + "/api/client/order/order_list/order_id?user_token="+USER_TOKEN+"&jane_name="+JANE_NAME,
            processData: false,
            contentType: false,
            xhrFields: {
                withCredentials: true
            },
            data: getFormData({
                pay_id: $('#orderId').val(),
                user_token: USER_TOKEN,
                jane_name: JANE_NAME
            }),
            success: function (res) {
                for(var i=0; i<res.data.length; i++) {
                    var resData = res.data[i]
                    if(resData.order_status != 60) {
                        timers = setTimeout(()=>{
                            setTimer()
                        },5000)
                        return
                    }
                }
                clearTimeout(timers);
                query(false)
            },
            error: function() {
                timers = setTimeout(()=>{
                    setTimer()
                },5000)
            }
        });
    }


    $(document).on('click','.rateExplicit .delete_btn',function (){
        $(".mask_body").show();
        $(".delete-pop").show()
        $(".delete-pop").attr('data-orderid',$(this).attr('data-orderid'))
    })
    // 删除
    $(".cancel_btn , .close_pop").on('click', function (){
        $(".mask_body").hide();
        $(".delete-pop").hide()
    })
    $(".determine_btn").click(function (){
        closeMsg = cocoMessage.loading('正在删除...');
        $.ajax({
            type: 'get',
            url: urls + '/api/client/order/del?user_token='+ USER_TOKEN +'&orderSn='+ $(".delete-pop").attr('data-orderid') +'&jane_name=' + JANE_NAME,
            success: function (res) {
                if (res.code == 200) {
                    $(".mask_body").hide();
                    $(".delete-pop").hide()
                    $('.orderId').val( $(".delete-pop").attr('data-orderid') )
                    query(false)
                }else {
                    cocoMessage.error(res.codeMsg, 2000);
                    closeMsg()
                }
            },
            error: function () {
                cocoMessage.error("请求失败!请检查网络", 2000);
                closeMsg()
            },
        });
    })

    var WxTime = 300;
    var WxTimeOut = null;
    function getWxCode(order_id, element){
        $.ajax({
            type: 'GET',
            url: urls + '/weixin/qr/bind_order?order_id=' + order_id,
            success: function (res){
                if(res.code == 200){
                    $('.'+element).attr('src', res.data)
                    $('.'+element).css('width', '100%')
                    WxTime = 300
                    WxPolling(order_id)
                }
            },
            error: function (err){
            }
        })
    }

    function WxPolling(order_id){
        $.ajax({
            type: 'GET',
            url: urls + '/weixin/qr/regist/query?bindOid=' + order_id,
            success: function (res){
                if(res.code == 200){
                    if(!res.data.isbind){
                        clearTimeout(WxTimeOut)
                        WxTimeOut = setTimeout(function (){
                            if(WxTime > 0){
                                WxTime--
                                WxPolling(order_id)
                            }
                        },1000)
                    }else{
                        query(false)
                        clearTimeout(WxTimeOut)
                    }
                }
            },
            error: function (err){

            }
        })
    }

    $('.deleteS').click(function() {
        deleteS()
        $('.deleteS').hide()
    })
    function deleteS(clearInput) {
        // 请求没有数据,判断是查询的本地id且查询的id和本地id一致, 就删除本地id(该id未支付)
        if(localStorage.getItem('oid') == $('.orderId').val()) {
            localStorage.removeItem('oid')
        }
        if(!clearInput){
            $('.orderId').val('')
        }
    }

    $(document).on('click','.CopyCode',function (){
        var text = $(this).data('code')
        if(text) {
            $("#copyInput").val(text)
            $("#copyInput").select()
            try {
                var state = document.execCommand("copy");
            } catch (err) {
                var state = false;
            }
            if (state) {
                cocoMessage.success(1000, "复制成功", function() {
                });
            } else {
                cocoMessage.error(1000, "复制失败", function() {
                });
            }
        }else {
            cocoMessage.error("复制失败, 请联系客服!", 2000);
        }
    })
</script>
</html>